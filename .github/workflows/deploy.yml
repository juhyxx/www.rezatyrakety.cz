name: Deploy changed files to FTP

on:
  push:
    branches:
      - master

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch full history
        run: git fetch --prune --unshallow

      - name: Get changed files
        id: changed-files
        run: |
          # Detect changed or added files
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          ADDED_FILES=$(git ls-files --others --exclude-standard)
          
          # Debugging: output the results of each command
          echo "Changed files: $CHANGED_FILES"
          echo "Added files: $ADDED_FILES"
          
          # Combine changed and added files
          ALL_FILES=$(echo "$CHANGED_FILES $ADDED_FILES" | tr '\n' ' ')

          # Debugging: check the value of ALL_FILES
          echo "All files: $ALL_FILES"
          
          # Remove files that start with a dot (e.g. .git, .github)
          ALL_FILES=$(echo "$ALL_FILES" | grep -v '^\.')

          # Debugging: check the value after removing dot files
          echo "Files after filtering: $ALL_FILES"
          
          # Check if there are any files to deploy
          if [ -z "$ALL_FILES" ]; then
            echo "No files to deploy, exiting."
            exit 0
          fi

          # Export the list of files to deploy
          echo "CHANGED_FILES=$ALL_FILES" >> $GITHUB_ENV

      - name: Upload changed files via FTP
        run: |
          sudo apt-get install -y lftp
          
          # Debugging: check the environment variable CHANGED_FILES
          echo "Files to upload: ${{ env.CHANGED_FILES }}"

          # Upload files
          for file in ${{ env.CHANGED_FILES }}; do
            # Ensure the file exists before attempting to upload
            if [ -f "$file" ]; then
              # Skip files starting with a dot (hidden files)
              if [[ "$file" == .* ]]; then
                echo "Skipping hidden file or directory: $file"
                continue
